#!/usr/bin/perl
#
# POD block.  To view these comments in a formatted fashion, use perldoc or
# any of the other POD utilities to form man-style pages.
#

=head1 NAME

B<gau-diff> - This script is used to diff to GAUSSIAN log files.

=head1 USAGE

To diff the GAUSSIAN output files named gauss-1.log and gauss-2.log use the
command:

=over

B<gau-diff> [I<options>] F<gauss-1.log> F<gauss-2.log>

=back

=head1 SYNOPSIS

The script begins by making modified versions of the two log files.  These
files will be called gau-diff.temp1 and gau-diff.temp2.  These files are
modified copies of the original log files containing only sections that are
to be compared.  By default, all initilization output (i.e., output printed
before entering Link 101), output printed after entering Link 9999, and
date stamps are ignored.  If the -link option is used then only print
generated by the specified link is considered.  After the two temp files
are written, the standard diff command is run.  Lastly, gau-diff.temp1 and
gau-diff.temp2 are both deleted (unless the -savefiles option is invoked).

As a final note, we point out that this script assumes that the "#p" option
has been used during the GAUSSIAN job executions.

=head1 OPTIONS

The available options are:

=over

=item B<-link=l>I<NNNN>

=over

Only print from link number I<NNNN> is compared.  By default all print
generated after the initialization print from Link 1 and before the final
print generated by Link 9999 is compared.  Also, by default, date stamps
and file paths are not compared.

=back

=item B<-savefiles>

=over

Save temparary files generated by this script.  These files are removed by
default.

=back

=back

=head1 AUTHOR

=over 2

=item Hrant P. Hratchian

=item Gaussian, Inc.

=item 340 Quinnipiac St, Bldg 40

=item Wallingford, CT 06492

=item hrant@gaussian.com

=back

=cut

#
#
#   Load the arguments and GAUSSIAN log file names from the command line.
#
    foreach (@ARGV){
      if(/^-link=l(\d+)$/i){
        $do_link = $1;
      }elsif(/^-numfilter$/i){
        $numfilter=1;
      }elsif(/^-savefiles$/i){
        $savefiles=1;
      }elsif(/^-(.*)/){
        die "\n\nUnknown argument sent to gau-diff.pl: $1\n\n";
      }else{
        push(@log_file_list,$_);
      }
    }
    if(@log_file_list != 2){die "\nWrong number of GAUSSIAN log files given!\n\n"}
    $log_file_1 = $log_file_list[0];
    $log_file_2 = $log_file_list[1];
#
#   Build the temp log files, gau-diff.temp1 and gau-diff.temp2.
#
    open LOG1,"< $log_file_1";
    $flag = 0;
    while(<LOG1>){
      chomp;
      if($do_link){
        if(/Enter.*l$do_link\.exe/){
          $flag = 1;
        }elsif(/Leave Link\s*$do_link\s*at/){
          $flag = 0;
        }elsif($flag==1 && ! (/TStamp/ || /Gau-\d+\.chk/)){
          $log1_lines .= "$_\n";
        }
      }else{
        if(/Enter.*l\d\d?\.exe/){
          $flag = 1;
        }elsif(/Enter.*l9999\.exe/){
          $flag = 0;
        }elsif(/Error termination via Lnk1e in/ || /Job cpu time:/ || /File lengths/){
          $flag = 0;
        }elsif($flag==1 && ! (/Enter.*l\d{1,4}\.exe/ || /Leave Link/ || /TStamp/ || /Gau-\d+\.chk/)){
          $log1_lines .= "$_\n";
        }
      }
    }
    close LOG1;
    open TEMP1,"> gau-diff.temp1";
    print TEMP1 "$log1_lines";
    close TEMP1;
#
    open LOG2,"< $log_file_2";
    $flag = 0;
    while(<LOG2>){
      chomp;
      if($do_link){
        if(/Enter.*l$do_link\.exe/){
          $flag = 1;
        }elsif(/Leave Link\s*$do_link\s*at/){
          $flag = 0;
        }elsif($flag==1 && ! (/TStamp/ || /Gau-\d+\.chk/)){
          $log2_lines .= "$_\n";
        }
      }else{
        if(/Enter.*l\d\d?\.exe/){
          $flag = 1;
        }elsif(/Enter.*l9999\.exe/){
          $flag = 0;
        }elsif(/Error termination via Lnk1e in/ || /Job cpu time:/ || /File lengths/){
          $flag = 0;
        }elsif($flag==1 && ! (/Enter.*l\d{1,4}\.exe/ || /Leave Link/ || /TStamp/ || /Gau-\d+\.chk/)){
          $log2_lines .= "$_\n";
        }
      }
    }
    close LOG2;
    open TEMP2,"> gau-diff.temp2";
    print TEMP2 "$log2_lines";
    close TEMP2;
#
#   Diff the two gau-diff.temp* files.
#   
    system "diff gau-diff.temp1 gau-diff.temp2";
#
#   Remove the two temp files.
#
    if($savefiles != 1){
      unlink "gau-diff.temp1";
      unlink "gau-diff.temp2";
    }
